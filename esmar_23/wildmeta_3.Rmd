---
title: "wildmeta  0.3.0: Cluster Wild Bootstrapping for Meta-Analysis"
subtitle: "ESMAR 2023"
author: "Megha Joshi, James E. Pustejovsky & Pierce Cappelli"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    includes:
      after_body: insert_logo.html
---


```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
library(xaringanExtra)

style_mono_accent(
  base_color = "#311432",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)

library(tidyverse)
library(knitr)
library(kableExtra)
library(wildmeta)
```


# wildmeta


```{r echo = FALSE, out.height = 500, out.width = 650, fig.align = "center"}
knitr::include_graphics("wildmeta_hex.png")
```

---

# Cluster Wild Bootstrapping (CWB)

- Dependent effect sizes common in meta-analyses
  - Multiple correlated outcome measures, repeated measures, multiple comparison group
  - Studies nested in some way   
  
- Ignore dependence 
  - Incorrect standard errors, incorrect inference from hypothesis tests
  
- Using RVE (CR2 + Satterthwaite df) recommended but can result in low power especially for multiple contrast hypothesis tests

- CWB maintains Type 1 error rates and has more power than RVE (Joshi, Pustejovsky & Beretvas, 2022)
  - CWB involves re-sampling residuals by multiplying them by cluster-level random weights (Cameron, Gelbach, and Miller 2008)
  
---

# wildmeta

- The main function in the package is `Wald_test_cwb()`

- Works with meta-regressions models fit using `robumeta::robu()`, `metafor::rma.mv()`, and `metafor::rma.uni()`

```{r, eval = F}
Wald_test_cwb(
  full_model,
  constraints,
  R,
  cluster = NULL,
  auxiliary_dist = "Rademacher",
  adjust = "CR0",
  type = "CR0",
  test = "Naive-F",
  seed = NULL
)
```

---

class: inverse, middle, center, cobBack

# Example


---

# Tanner-Smith and Lipsey (2015)

- Tanner-Smith and Lipsey (2015) meta-analysis of the effects of brief alcohol interventions on alcohol consumption and behavior

  - 185 studies, 1446 effect sizes
    - Studies had multiple effect sizes
  - Multiple correlated outcome measures: e.g., alcohol consumption measured by frequency of consumption, quantity consumed, blood alcohol concentration
  - Repeated measures
  - Multiple comparison groups
  
- Example RQ:  Do effects of brief alcohol interventions differ across different outcome measurements?
  
---

# Data


```{r, warning = F, message = F, echo = F}
library(DT)
library(tidyverse)

load("tsl_dat_20.RData")

tsl_dat <- 
  tsl_dat %>%
  mutate(dv = case_when(dv == "bac" ~ "Blood alcohol concentration",
                        dv == "comb" ~ "Combined measures (e.g., AUDIT)",
                        dv == "fhu" ~ "Frequency of heavy use",
                        dv == "fu" ~ "Frequency of use",
                        dv == "pc" ~ "Peak consumption",
                        dv == "qu" ~ "Quantity of use"))

DT::datatable(tsl_dat %>%
                mutate_if(is.numeric, round, 3))
```

---

# robumeta Model

```{r, warning = FALSE, message = FALSE}
library(wildmeta)
library(clubSandwich)
library(robumeta)

robu_tsl <- robu(delta ~ g2age + dv, 
                 studynum = study, 
                 var.eff.size = v,
                 small = TRUE,
                 data = tsl_dat)
```

# Wald_test_cwb()

```{r, message = F, warning = F, eval = F}
robu_res <- Wald_test_cwb(robu_tsl, 
                          constraints = constrain_zero(3:7),
                          R = 999,
                          seed = 20230123)

robu_res
```

```{r, echo = F}
#save(robu_res, file = "robu_res.RData")
load("robu_res.RData")
robu_res
```

---

# Parallel Processing

```{r}
library(future)

if (parallelly::supportsMulticore()) {
  plan(multicore) 
} else {
  plan(multisession)
}

nbrOfWorkers()

system.time(
  res <- Wald_test_cwb(full_model = robu_tsl,
                       constraints = constrain_equal(1:3),
                       R = 1999, 
                       seed = 20230124)
)

```


```{r, echo = F}
save(res, file = "robu_res_p.RData")
load("robu_res_p.RData")
res
```
---
