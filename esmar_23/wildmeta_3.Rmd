---
title: "wildmeta  0.3.0: Cluster Wild Bootstrapping for Meta-Analysis"
subtitle: "ESMAR 2023"
author: "Megha Joshi, James E. Pustejovsky & Pierce Cappelli"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    includes:
      after_body: insert_logo.html
---

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
library(xaringanExtra)

style_mono_accent(
  base_color = "#311432",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)

library(tidyverse)
library(knitr)
library(kableExtra)
library(wildmeta)
library(future)
library(metafor)
library(clubSandwich)
```



# Cluster Wild Bootstrapping (CWB)

- Dependent effect sizes common in meta-analyses
  - Multiple correlated outcome measures, repeated measures, multiple comparison group
  - Studies nested in some way   
  
- Ignore dependence 
  - Incorrect standard errors, incorrect inference from hypothesis tests
  
- Using RVE (CR2 + Satterthwaite df) recommended but can result in low power especially for multiple contrast hypothesis tests

- CWB maintains Type 1 error rates and has more power than RVE (Joshi, Pustejovsky & Beretvas, 2022)
  - CWB involves re-sampling residuals by multiplying them by cluster-level random weights (Cameron, Gelbach, and Miller 2008)
  
---

# wildmeta

- The main function in the package is `Wald_test_cwb()`

- Works with meta-regressions models fit using `robumeta::robu()`, `metafor::rma.mv()`, and `metafor::rma.uni()`

```{r, eval = F}
Wald_test_cwb(
  full_model,
  constraints,
  R,
  cluster = NULL,
  auxiliary_dist = "Rademacher",
  adjust = "CR0",
  type = "CR0",
  test = "Naive-F",
  seed = NULL
)
```

---

class: inverse, middle, center, cobBack, hide-logo

# Example


---

# Tanner-Smith and Lipsey (2015)

- Tanner-Smith and Lipsey (2015) meta-analysis of the effects of brief alcohol interventions on alcohol consumption and behavior

  - 185 studies, 1446 effect sizes
    - Studies had multiple effect sizes
  - Multiple correlated outcome measures: e.g., alcohol consumption measured by frequency of consumption, quantity consumed, blood alcohol concentration
  - Repeated measures
  - Multiple comparison groups
  
- Example RQ:  Do effects of brief alcohol interventions differ across different outcome measurements?
  
---

# Data


```{r, warning = F, message = F, echo = F}
library(DT)
library(tidyverse)

load("tsl_dat_20.RData")

tsl_dat <- 
  tsl_dat %>%
  mutate(dv = case_when(dv == "bac" ~ "Blood alcohol concentration",
                        dv == "comb" ~ "Combined measures (e.g., AUDIT)",
                        dv == "fhu" ~ "Frequency of heavy use",
                        dv == "fu" ~ "Frequency of use",
                        dv == "pc" ~ "Peak consumption",
                        dv == "qu" ~ "Quantity of use"))

DT::datatable(tsl_dat %>%
                mutate_if(is.numeric, round, 3))
```

---

# robumeta Model

```{r, warning = FALSE, message = FALSE}
library(wildmeta)
library(clubSandwich)
library(robumeta)

robu_tsl <- robu(delta ~ 0 + dv + g2age, 
                 studynum = study, 
                 var.eff.size = v,
                 small = TRUE,
                 data = tsl_dat)
```

---

# Wald_test_cwb()

```{r, message = F, warning = F, eval = F}
robu_res <- Wald_test_cwb(robu_tsl, 
                          constraints = constrain_equal(1:6),
                          R = 999,
                          seed = 20230123)

robu_res
```

```{r, echo = F}
#save(robu_res, file = "robu_res.RData")
load("robu_res.RData")
robu_res
```

---

# Parallel Processing

```{r, message = F, warning = F}
if (parallelly::supportsMulticore()) {
  plan(multicore) 
} else {
  plan(multisession)
}

nbrOfWorkers()

system.time(
  res <- Wald_test_cwb(full_model = robu_tsl,
                       constraints = constrain_equal(1:6),
                       R = 1999, 
                       seed = 20230124)
)


```

---

# Parallel Processing

```{r, eval = FALSE}
res
```


```{r, echo = F}
#save(res, file = "robu_res_p.RData")
load("robu_res_p.RData")
res
```

---

# Using `metafor`

```{r, echo = F}
library(metafor)

rma_tsl <- rma.mv(yi = delta, 
                  V = v,
                  mods = ~ 0 + dv + g2age, 
                  random = ~ dv | study,
                  data = tsl_dat)
```

```{r, eval = FALSE}
plan(multisession)

metafor_res <- Wald_test_cwb(full_model = rma_tsl,
                             constraints = constrain_equal(1:6),
                             R = 999, 
                             seed = 20230125)

metafor_res

```

```{r, echo = F}
#save(metafor_res, file = "metafor_res.RData")
load("metafor_res.RData")
metafor_res
```


---

class: inverse, middle, center, cobBack, hide-logo

# THANK YOU!

---

class: inverse, hide-logo

# References

Boos, D. D., & others. (2003). Introduction to the bootstrap world. Statistical Science, 18(2), 168–174. 

Cameron, A. C., Gelbach, J. B., & Miller, D. L. (2008). Bootstrap-Based Improvements for Inference with Clustered Errors. The Review of Economics and Statistics, 47.

Hedges, L. V., Tipton, E., & Johnson, M. C. (2010). Robust variance estimation in meta-regression with dependent effect size estimates. Research Synthesis Methods, 1(1), 39–65.

Joshi, M., Pustejovsky, J. E., & Beretvas, S. N. (2022). Cluster wild bootstrapping to handle dependent effect sizes in meta-analysis with small number of studies. Research Synthesis Methods. Research Synthesis Methods.

Joshi, M., Pustejovsky, J. E. & Cappelli, P. (2022). wildmeta: Cluster Wild Bootstrapping for Meta-Analysis. R package version 0.3.0. https://CRAN.R-project.org/package=wildmeta

---

class: inverse, hide-logo

# References

Tanner-Smith, E. E., & Lipsey, M. W. (2015). Brief alcohol interventions for adolescents and young adults: A systematic review and meta-analysis. Journal of substance abuse treatment, 51, 1-18.

Tipton, E., & Pustejovsky, J. E. (2015). Small-Sample Adjustments for Tests of Moderators and Model Fit Using Robust Variance Estimation in Meta-Regression. Journal of Educational and Behavioral Statistics, 40 (6), 604–634. 

Tipton, E. (2015). Small sample adjustments for robust variance estimation with meta-regression. Psychological Methods, 20(3), 375–393. 